<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
		integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">

	<title>Punto de Venta - RyR Computacion</title>
</head>

<body>

	<style>
		body {
			font-family: "Lato", sans-serif;
			font-size: 18px;
		}

		.sidenav {
			height: 100%;
			width: 160px;
			position: fixed;
			z-index: 1;
			top: 0;
			left: 0;
			background-color: #111;
			overflow-x: hidden;
			padding-top: 20px;
		}

		.sidenav a {
			padding: 6px 8px 6px 16px;
			text-decoration: none;
			font-size: 18px;
			color: #f1f1f1;
			display: block;
		}

		.span {
			font-size: 18px;
		}

		.sidenav a:hover {
			color: #f1f1f1;
		}

		.main {
			margin-left: 160px;
			/* Same as the width of the sidenav */
			font-size: 16px;
			/* Increased text to enable scrolling */
			padding: 0px 10px;
		}

		@media screen and (max-height: 450px) {
			.sidenav {
				padding-top: 15px;
			}

			.sidenav a {
				font-size: 16px;
			}

		}

		@media screen and (max-width: 450px) {
			.ui-autocomplete {
				max-width: 80%;
				max-height: 200px;
				overflow-y: auto;
				/* prevent horizontal scrollbar */
				overflow-x: hidden;
				/* add padding to account for vertical scrollbar */
				padding-right: 20px;
			}

		}

		.ui-autocomplete {
			max-width: 100%;
			max-height: 200px;
			overflow-y: auto;
			/* prevent horizontal scrollbar */
			overflow-x: hidden;
			/* add padding to account for vertical scrollbar */
			padding-right: 20px;
		}
	</style>



	<div class="sidenav bg-danger">

		<div class="">
			<img th:src="@{../img/logo.png}" style="max-width: 100%;"></img>
		</div>

		<a href="#">Inicio</a>
		<a href="#">Factura</a>
	</div>

	<div class="main">

		<div class="col-12">

			<div class="alert alert-success" role="alert" th:if="${success != null}" th:text="${success}"
				style="margin:10px;">

			</div>

			<div class="alert alert-success" role="alert" th:if="${encontrado != null}" th:text="${encontrado}"
				style="margin:10px;">

			</div>

			<div class="alert alert-danger" role="alert" th:if="${no_encontrado != null}" th:text="${no_encontrado}"
				style="margin:10px;">

			</div>

			<div class="alert alert-danger" role="alert" th:if="${error != null}" th:text="${error}"
				style="margin:10px;">

			</div>

			<br>

			<div class="container">
				<form class="row g-3" th:action="@{/factura}" method="post" id="form_cliente">
					<div class="input-group">
						<input type="text" class="form-control"
							th:placeholder="${cliente == null ? 'Cargar Cliente':cliente.cli_codigo + ', ' + cliente.razon_social}"
							aria-label="Buscar Cliente" aria-describedby="button-addon2" id="buscar_cliente"
							name="buscar_cliente" required>
						<input type="hidden" id="ingresar_cliente" name="ingresar_cliente">
					</div>
				</form>
			</div>

			<br th:if="${cliente != null}">

			<div class="container" th:if="${cliente != null}">
				<li class="list-group-item bg-info" aria-current="true">
					<i class="far fa-id-card"></i> <span
						th:text="'Datos del Cliente: ' + ${cliente.cli_codigo} + ', ' + ${cliente.razon_social}"
						style="padding-left: 5px"></span>
				</li>
				<ul class="list-group list-group-horizontal-md">
					<li class="list-group-item flex-fill" th:text="'Cod Cliente: ' + ${cliente.cli_codigo}"></li>
					<li class="list-group-item flex-fill" th:text="'Razón Social: ' + ${cliente.razon_social}"></li>
					<li class="list-group-item flex-fill"
						th:text="'Tipo Cliente: ' + ${cliente.fkidtipocliente.tipo_cliente}">
					</li>
				</ul>
				<ul class="list-group list-group-horizontal-md">
					<li class="list-group-item flex-fill"
						th:text="'Tipo Documento: ' + ${cliente.fkidtipodocumento.tipo_documento}"></li>
					<li class="list-group-item flex-fill" th:text="'Nro Documento: ' + ${cliente.nro_documento}"></li>

					<li class="list-group-item flex-fill"
						th:text="'Localidad: ' + ${cliente.fkidlocalidadcliente.localidad} + ', ' + ${cliente.fkidlocalidadcliente.id_provincia.provincia}">
					</li>
				</ul>
				<br>

				<ul class="list-group">
					<li class="list-group-item disabled bg-info" aria-disabled="true" style="color:black">
						<i class="fas fa-clipboard-list"></i> Lista de Precios Asociada</li>
					<li class="list-group-item" th:each="lista_precio : ${lista_precio_cliente}"><a
							class="dropdown-item" th:href="@{/factura/} + ${lista_precio.fkIdLista.id_lista_precio}"
							th:text="${lista_precio.fkIdLista.nombre}"></a></li>
				</ul>
				<br>

				<div th:if="${lista_precio != null}">
					<ul class="list-group">
						<li class="list-group-item disabled bg-info" aria-disabled="true" style="color:black">
							<i class="far fa-credit-card"></i> Tipos de Pagos</li>
						<li class="list-group-item">
							<form th:action="@{/cargar_tipo_de_pago}">
								<div class="input-group">
									<select class="form-select" id="inputGroupSelect04" name="tipo_de_pago">
										<option th:each="tipo_pago : ${tipos_pagos_lista_precio}"
											th:if="${tipo_pago_lista_precio != null}"
											th:text="${tipo_pago.fkIdListaTipoPago.nombre}"
											th:value="${tipo_pago.id_tipo_pago_lista_precio}"
											th:selected="${tipo_pago.id_tipo_pago_lista_precio == tipo_pago_lista_precio.id_tipo_pago_lista_precio}">
										</option>

										<option th:each="tipo_pago : ${tipos_pagos_lista_precio}"
											th:if="${tipo_pago_lista_precio == null}"
											th:text="${tipo_pago.fkIdListaTipoPago.nombre}"
											th:value="${tipo_pago.id_tipo_pago_lista_precio}"></option>
									</select>
									<button class="btn btn-outline-secondary" type="submit">Cargar</button>
								</div>
							</form>
						</li>
					</ul>

				</div>

			</div>

			<br>

			<div class="accordion accordion-flush" id="accordionFlushExample" th:if="${tipo_pago_lista_precio != null}">
				<div class="accordion-item">
					<h2 class="accordion-header" id="flush-headingTwo">
						<button class="accordion-button" type="button" data-bs-toggle="collapse"
							data-bs-target="#flush-collapseTwo" aria-expanded="true" aria-controls="flush-collapseTwo"
							th:value="${tipo_pago_lista_precio.fkIdListaTipoPago.porcentaje}" id="tipo_pago">
							<i class="fas fa-cash-register"></i> <span
								th:text="'Facturación - Tipo de Pago: ' + ${tipo_pago_lista_precio.fkIdListaTipoPago.nombre}"
								style="padding-left: 5px;"></span>
						</button>
					</h2>
					<div id="flush-collapseTwo" class="accordion-collapse collapse show"
						aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
						<div class="accordion-body">

							<div class="container" th:if="${tipo_pago_lista_precio != null}">
								<form class="row g-3" id="detalles_factura" th:action="@{/detalles_factura}"
									th:object="${factura}" method="post">
									<div class="col-12">
										<label class="form-label"><i class="fas fa-shopping-cart"></i> Cargar
											Producto:</label>
										<input type="text" class="form-control" placeholder="Cargar Producto"
											aria-label="Cargar Producto" aria-describedby="button-addon2"
											id="buscar_producto" name="buscar_producto">
										<input type="hidden" id="ingresar_producto" name="ingresar_producto">
									</div>
									<div class="col-md-6 col-lg-12">
										<label class="form-label"><i class="fas fa-edit"></i> Descripción
											Factura:</label>
										<textarea class="form-control" aria-label="With textarea" required
											th:field="*{descripcion}"></textarea>
									</div>
									<div class="col-md-6 col-lg-12">
										<label class="form-label"><i class="far fa-eye"></i> Observación:</label>
										<textarea class="form-control" aria-label="With textarea" required
											th:field="*{observacion}"></textarea>
									</div>
									<div class="col-12">
										<div class="table-responsive">
											<table th:replace="plantilla-items :: itemsFactura"></table>
										</div>
										<div class="table-responsive">
											<table id="cargarItemsProductos"
												class="table table-sm table-striped table-hover">
												<thead>
													<tr>
														<th>Descripción:</th>
														<th>Precio:</th>
														<th>Cantidad:</th>
														<th>Total:</th>
														<th>Eliminar</th>
													</tr>
												</thead>
												<tbody>

												</tbody>
											</table>


											<div class="modal fade" id="info" tabindex="-1"
												aria-labelledby="exampleModalLabel" aria-hidden="true">
												<div class="modal-dialog">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title" id="exampleModalLabel">Info Total
															</h5>
															<button type="button" class="btn-close"
																data-bs-dismiss="modal" aria-label="Close"></button>
														</div>
														<div class="modal-body">
															<h4>Interes: <span id="porcentaje"></span>%</h4>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary"
																data-bs-dismiss="modal">Cerrar</button>
														</div>
													</div>
												</div>
											</div>

											<ul class="list-group">
												<li
													class="list-group-item d-flex justify-content-between align-items-center">
													<h5 class="text-primary">Total <a data-bs-toggle="modal"
															data-bs-target="#info"><i
																class="fas fa-info-circle"></i></a> :</h5>

													<span class="badge bg-primary rounded-pill" id="gran_total">0</span>
												</li>


											</ul>


										</div>
									</div>
									<div class="col-12">
										<button type="submit" class="btn btn-primary"><i
												class="fas fa-cash-register"></i> Facturar</button>
									</div>
								</form>
							</div>

						</div>
					</div>
				</div>
			</div>


		</div>


	</div>


	<!-- Optional JavaScript; choose one of the two! -->

	<!-- Option 1: Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>

	<!-- Option 2: Separate Popper and Bootstrap JS -->
	<!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->

	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>

	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	<script>
		var porcentaje = $("#tipo_pago").val();

		$(document).ready(function () {
			$('#porcentaje').html(parseInt(porcentaje));
		});

		$(document).ready(function () {
			$("#buscar_cliente").autocomplete({
				source: function (request, response) {

					$.ajax({
						url: "/cargar_cliente/" + request.term,
						datatype: "json",
						data: {
							term: request.term
						},
						success: function (data) {
							response($.map(data, function (item) {
								return {
									value: item.cli_codigo,
									label: item.cli_codigo + ', ' + item.razon_social
								};
							}));
						},
					});

				},
				select: function (event, ui) {
					$("#buscar_cliente").val(ui.item.label);
					//$("#buscar_dire").click();

					$("#ingresar_cliente").val(ui.item.value);

					$("#form_cliente").submit();

					return false;
				}
			});
		});

		$(document).ready(function () {
			$("#buscar_producto").autocomplete({
				source: function (request, response) {

					$.ajax({
						url: "/cargar_producto/" + request.term,
						datatype: "json",
						data: {
							term: request.term
						},
						success: function (data) {
							response($.map(data, function (item) {
								return {
									value: item.fkidproductolista.pro_codigo,
									label: item.fkidproductolista.pro_codigo + ', ' + item.fkidproductolista.descripcion,
									precing: item.importe,
									unidad: item.cantidadminima
								};
							}));
						},
					});

				},
				select: function (event, ui) {


					if (itemsHelper.hasProducto(ui.item.value)) {
						itemsHelper.incrementaCantidad(ui.item.value, parseFloat(ui.item.precing + ((ui.item.precing * porcentaje) / 100)).toFixed(2), parseInt(ui.item.unidad));
						return false;
					}

					var linea = $("#plantillaItemsFactura").html();

					linea = linea.replace(/{ID}/g, ui.item.value);
					linea = linea.replace(/{DESCRIPCION}/g, ui.item.label);
					linea = linea.replace(/{UNIDAD}/g, ui.item.unidad);
					linea = linea.replace(/{PRECIO}/g, parseFloat(ui.item.precing + ((ui.item.precing * porcentaje) / 100)).toFixed(2));
					linea = linea.replace(/{PORCENTAJE}/g, parseInt(porcentaje) + '%');
					$("#cargarItemsProductos tbody").append(linea);
					itemsHelper.calcularImporte(ui.item.value, parseFloat(ui.item.precing + ((ui.item.precing * porcentaje) / 100)).toFixed(2), parseInt(ui.item.unidad));
					return false;
				}
			});

			$("#detalles_factura").submit(function () {
				$("#plantillaItemsFactura").remove();
				return;
			});

		});

		var itemsHelper = {
			calcularImporte: function (id, precio, cantidad) {
				$("#total_importe_" + id).html(parseFloat(precio * cantidad).toFixed(2));
				this.calcularGranTotal();
			},
			hasProducto: function (id) {

				var resultado = false;

				$('input[name="item_id[]"]').each(function () {
					if (parseInt(id) == parseInt($(this).val())) {
						resultado = true;
					}
				});

				return resultado;
			},
			incrementaCantidad: function (id, precio, unidad) {
				var cantidad = $("#cantidad_" + id).val() ? parseInt($("#cantidad_" + id).val()) : 0;
				$("#cantidad_" + id).val(cantidad + unidad);
				console.log(cantidad + unidad);
				this.calcularImporte(id, parseFloat(precio).toFixed(2), cantidad + unidad);
			},
			eliminarLineaFactura: function (id) {
				$("#row_" + id).remove();
				this.calcularGranTotal();
			},
			calcularGranTotal: function () {
				var total = 0;
				$('span[id^="total_importe_"]').each(function () {
					total += parseFloat($(this).html());
				});

				$('#gran_total').html('$' + parseFloat(total).toFixed(2));
			}
		}

		$(document).ready(function () {
			$(".alert").delay(4000).slideUp(200, function () {
				$(this).alert('close');
			});
		});

		function handleSelect(elm) {
			window.location = elm.value;
		}



	</script>

</body>

</html>